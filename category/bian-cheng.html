<!DOCTYPE html>
<html lang="cn">
<head>
        <meta charset="utf-8" />
        <title>Rothcold - 编程</title>
        <link rel="stylesheet" href="http://rothcold.github.io/blog/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://rothcold.github.io/blog/">Rothcold </a></h1>
                <nav><ul>
                    <li class="active"><a href="http://rothcold.github.io/blog/category/bian-cheng.html">编程</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="http://rothcold.github.io/blog/html5-ajax-canvassuo-fang-tu-pian-hou-hou-bian-cheng-wen-jian-bing-shang-chuan-de-fang-fa.html">HTML5 Ajax Canvas缩放图片后后变成文件并上传的方法</a></h1>
<footer class="post-info">
        <abbr class="published" title="2014-03-24T21:17:00+08:00">
                Published: Mon 24 March 2014
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="http://rothcold.github.io/blog/author/rothcold.html">Rothcold</a>
        </address>
<p>In <a href="http://rothcold.github.io/blog/category/bian-cheng.html">编程</a>. </p>

</footer><!-- /.post-info --><p>最近做的应用里面有上传图片的功能，由于图片直接丢进七牛云存储，所以不想通过服务器端程序来写缩放功能，查了一下找到一篇文章，<a href="http://hacks.mozilla.org/2011/01/how-to-develop-a-html5-image-uploader/">点我</a> ，这篇总体步骤来说是OK的，但是里面有好多坑。</p>
<p>本来准备把上传的独立一篇写出来的，后来发现太短，加到后面吧。</p>
<p>PS：想直接看完整可以用版代码的请直接拖到最下。</p>
<p>首先创建Img并画到Canvas上这一步，他的代码连起来是这样的：</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;img&quot;</span><span class="p">);</span>
<span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">MAX_WIDTH</span> <span class="o">=</span> <span class="mi">800</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">MAX_HEIGHT</span> <span class="o">=</span> <span class="mi">600</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="nx">img</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="nx">img</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">width</span> <span class="o">&gt;</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">width</span> <span class="o">&gt;</span> <span class="nx">MAX_WIDTH</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">height</span> <span class="o">*=</span> <span class="nx">MAX_WIDTH</span> <span class="o">/</span> <span class="nx">width</span><span class="p">;</span>
        <span class="nx">width</span> <span class="o">=</span> <span class="nx">MAX_WIDTH</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">height</span> <span class="o">&gt;</span> <span class="nx">MAX_HEIGHT</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">width</span> <span class="o">*=</span> <span class="nx">MAX_HEIGHT</span> <span class="o">/</span> <span class="nx">height</span><span class="p">;</span>
        <span class="nx">height</span> <span class="o">=</span> <span class="nx">MAX_HEIGHT</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">width</span><span class="p">;</span>
<span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">height</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">&quot;2d&quot;</span><span class="p">);</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>
</pre></div>


<p>但是这样写Canvas里面什么都不会出现，我昨天跟这段代码战斗了小半天，才发现他应该改成：</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;img&quot;</span><span class="p">);</span>
<span class="nx">img</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">MAX_WIDTH</span> <span class="o">=</span> <span class="mi">800</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">MAX_HEIGHT</span> <span class="o">=</span> <span class="mi">600</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="nx">img</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="nx">img</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">width</span> <span class="o">&gt;</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">width</span> <span class="o">&gt;</span> <span class="nx">MAX_WIDTH</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">height</span> <span class="o">*=</span> <span class="nx">MAX_WIDTH</span> <span class="o">/</span> <span class="nx">width</span><span class="p">;</span>
            <span class="nx">width</span> <span class="o">=</span> <span class="nx">MAX_WIDTH</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">height</span> <span class="o">&gt;</span> <span class="nx">MAX_HEIGHT</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">width</span> <span class="o">*=</span> <span class="nx">MAX_HEIGHT</span> <span class="o">/</span> <span class="nx">height</span><span class="p">;</span>
            <span class="nx">height</span> <span class="o">=</span> <span class="nx">MAX_HEIGHT</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">width</span><span class="p">;</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">height</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">&quot;2d&quot;</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
</pre></div>


<p>这是因为Javascript是异步调用的，正序执行的时候img还没画出来，ctx.drawImage已经调用了，导致什么效果都没有。</p>
<p>上面那段代码的最后一句也是个坑，在Chrome，Safari下都报错，其实应该写成：</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">myURL</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">URL</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">webkitURL</span>
<span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">myURL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
</pre></div>


<p>然后要将Canvas转换成文件来上传，这篇写了这两个方法：</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">dataurl</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">toDataURL</span><span class="p">(</span><span class="s2">&quot;image/png&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">mozGetAsFile</span><span class="p">(</span><span class="s2">&quot;foo.png&quot;</span><span class="p">);</span>
</pre></div>


<p>然而实际上mozGetAsFile只有Firefox支持，所以为了兼容Chrome跟Safari我去查了一下dataurl怎么用。这个原文就找不到了，也被坑了一次，搜索到的前几条好多BlobBuilder的，这玩意不知道什么时候就deprecated了，最新版的Chrome跟Safari都没这类，最终找到了一个ArrayBuffer直接转换blob的代码：</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">dataURItoBlob</span><span class="p">(</span><span class="nx">dataURI</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">byteString</span> <span class="o">=</span> <span class="nx">atob</span><span class="p">(</span><span class="nx">dataURI</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="kd">var</span> <span class="nx">mimeString</span> <span class="o">=</span> <span class="nx">dataURI</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="kd">var</span> <span class="nx">ab</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="nx">byteString</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">ia</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">ab</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">byteString</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ia</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">byteString</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">dataView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="nx">ab</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">dataView</span><span class="p">],</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">mimeString</span> <span class="p">})</span>
    <span class="k">return</span> <span class="nx">blob</span>
<span class="p">}</span>
</pre></div>


<p>这段代码在Chrome里面用的毫无问题，但是Safari生成的blob只有十几字节，这明显不科学。<a href="https://developer.mozilla.org/en-US/docs/Web/API/Blob?redirectlocale=en-US&amp;redirectslug=DOM%2FBlob">MDN Blob</a> 上查到可以直接把ArrayBuffer传到Blob构造函数里面，于是就变成了</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">ab</span><span class="p">],</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">mimeString</span> <span class="p">})</span>
</pre></div>


<p>现在圆满了，就剩一个小问题，Chrome下会提示把ArrayBuffer传入Blob构造函数的行为deprecated了。</p>
<p>接下来就是文件上传了，用到了jQuery。</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">formData</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FormData</span><span class="p">()</span>
<span class="nx">formData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="nx">imgFile</span><span class="p">)</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="s1">&#39;http://example.com/upload&#39;</span><span class="p">,{</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
    <span class="nx">contentType</span><span class="o">:</span> <span class="s1">&#39;multipart/form-data;&#39;</span><span class="p">,</span>
    <span class="nx">xhr</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>  <span class="c1">// 自定义xhr</span>
        <span class="nx">myXhr</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ajaxSettings</span><span class="p">.</span><span class="nx">xhr</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">eventSource</span> <span class="o">=</span> <span class="nx">myXhr</span><span class="p">.</span><span class="nx">upload</span> <span class="o">||</span> <span class="nx">myXhr</span><span class="p">;</span>
        <span class="nx">eventSource</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span><span class="nx">progressHandler</span><span class="p">);</span> <span class="c1">// 处理上传进度，大文件的时候很有必要</span>
        <span class="k">return</span> <span class="nx">myXhr</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="c1">//Ajax events</span>
    <span class="nx">success</span><span class="o">:</span> <span class="nx">successHandler</span><span class="p">,</span>
    <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">jqXHR</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">errorThrown</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="nx">data</span><span class="o">:</span> <span class="nx">formData</span><span class="p">,</span>
    <span class="nx">cache</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">contentType</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">processData</span><span class="o">:</span> <span class="kc">false</span>
<span class="p">})</span>
<span class="kd">function</span> <span class="nx">progressHandler</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">percent</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span> <span class="nx">progressEvent</span><span class="p">.</span><span class="nx">loaded</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="nx">progressEvent</span><span class="p">.</span><span class="nx">total</span><span class="p">);</span>
    <span class="c1">//你的进度条处理方法</span>
<span class="p">}</span>
</pre></div>


<p>这个没啥坑，有个小问题，按之前的办法生成的Blob拿过来上传的时候在Firefox里面无法显示Progress，应该是Firefox只有上传文件才有prgress事件。</p>
<p>以下是完整可用代码：</p>
<div class="highlight"><pre><span class="nx">fileinput</span><span class="p">.</span><span class="nx">onchange</span> <span class="o">=</span> <span class="nx">getImgFile</span> <span class="c1">//file input的change事件绑定</span>
<span class="kd">var</span> <span class="nx">imgFile</span>
<span class="kd">function</span> <span class="nx">getImgFile</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;img&quot;</span><span class="p">)</span>
    <span class="nx">img</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;coverFileCanvas&quot;</span><span class="p">)</span>
        <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">&quot;2d&quot;</span><span class="p">)</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">WIDTH</span><span class="p">,</span> <span class="nx">HEIGHT</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">mozGetAsFile</span><span class="p">){</span>
            <span class="nx">imgFile</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">mozGetAsFile</span><span class="p">(</span><span class="s2">&quot;img.png&quot;</span><span class="p">)</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="kd">var</span> <span class="nx">dataURL</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">toDataURL</span><span class="p">(</span><span class="s2">&quot;image/png&quot;</span><span class="p">)</span>
            <span class="kd">var</span> <span class="nx">filenameParts</span> <span class="o">=</span> <span class="nx">coverfile</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="kd">var</span> <span class="nx">extension</span> <span class="o">=</span> <span class="nx">filenameParts</span><span class="p">[</span><span class="nx">filenameParts</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="nx">imgFile</span> <span class="o">=</span> <span class="nx">dataURItoBlob</span><span class="p">(</span><span class="nx">dataURL</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">myURL</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">URL</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">webkitURL</span>
    <span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">myURL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">file</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">dataURItoBlob</span><span class="p">(</span><span class="nx">dataURI</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">byteString</span> <span class="o">=</span> <span class="nx">atob</span><span class="p">(</span><span class="nx">dataURI</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="kd">var</span> <span class="nx">mimeString</span> <span class="o">=</span> <span class="nx">dataURI</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="kd">var</span> <span class="nx">ab</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="nx">byteString</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">ia</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">ab</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">byteString</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ia</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">byteString</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">ab</span><span class="p">],</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">mimeString</span> <span class="p">})</span>
    <span class="k">return</span> <span class="nx">blob</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">fileUpload</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">formData</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FormData</span><span class="p">()</span>
    <span class="nx">formData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="nx">imgFile</span><span class="p">)</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="s1">&#39;http://example.com/upload&#39;</span><span class="p">,{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
        <span class="nx">contentType</span><span class="o">:</span> <span class="s1">&#39;multipart/form-data;&#39;</span><span class="p">,</span>
        <span class="nx">xhr</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>  <span class="c1">// 自定义xhr</span>
            <span class="nx">myXhr</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">ajaxSettings</span><span class="p">.</span><span class="nx">xhr</span><span class="p">();</span>
            <span class="kd">var</span> <span class="nx">eventSource</span> <span class="o">=</span> <span class="nx">myXhr</span><span class="p">.</span><span class="nx">upload</span> <span class="o">||</span> <span class="nx">myXhr</span><span class="p">;</span>
            <span class="nx">eventSource</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span><span class="nx">progressHandler</span><span class="p">);</span> <span class="c1">// 处理上传进度，大文件的时候很有必要</span>
            <span class="k">return</span> <span class="nx">myXhr</span><span class="p">;</span>
        <span class="p">},</span>
        <span class="c1">//Ajax events</span>
        <span class="nx">success</span><span class="o">:</span> <span class="nx">successHandler</span><span class="p">,</span>
        <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">jqXHR</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">,</span> <span class="nx">errorThrown</span><span class="p">){</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">errorThrown</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="nx">data</span><span class="o">:</span> <span class="nx">formData</span><span class="p">,</span>
        <span class="nx">cache</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">contentType</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">processData</span><span class="o">:</span> <span class="kc">false</span>
    <span class="p">})</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">progressHandler</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">percent</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span> <span class="nx">progressEvent</span><span class="p">.</span><span class="nx">loaded</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="nx">progressEvent</span><span class="p">.</span><span class="nx">total</span><span class="p">);</span>
    <span class="c1">//你的进度条处理方法</span>
<span class="p">}</span>
</pre></div>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="http://weibo.com/rothcold">新浪微博</a></li>
                            <li><a href="http://twitter.com/rothcold">Twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>